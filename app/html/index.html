<!DOCTYPE html>
<!-- DetectX v3.6.0 - Modern UI with Top Navigation -->
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Model</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/app.css?v=3.6.0">
    <script src="js/jquery-3.7.1.min.js"></script>
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/media-stream-player.min.js"></script>

<style>
    :root {
        --primary-color: #2563eb;
        --primary-dark: #1e40af;
        --primary-light: #3b82f6;
        --success-color: #10b981;
        --danger-color: #ef4444;
        --warning-color: #f59e0b;
        --info-color: #06b6d4;
        --bg-light: #f8fafc;
        --bg-white: #ffffff;
        --text-dark: #1e293b;
        --text-muted: #64748b;
        --border-color: #e2e8f0;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background-color: var(--bg-light);
        color: var(--text-dark);
    }

    /* Top Navigation Bar */
    .top-navbar {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        box-shadow: var(--shadow-lg);
        padding: 0;
        min-height: 64px;
    }

    .navbar-brand {
        font-size: 1.5rem;
        font-weight: 600;
        color: white !important;
        padding: 0.75rem 1.5rem;
    }

    .nav-pills .nav-link {
        color: rgba(255, 255, 255, 0.85);
        border-radius: 8px;
        padding: 0.65rem 1.25rem;
        margin: 0 0.25rem;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .nav-pills .nav-link:hover {
        background-color: rgba(255, 255, 255, 0.15);
        color: white;
    }

    .nav-pills .nav-link.active {
        background-color: rgba(255, 255, 255, 0.25);
        color: white;
        font-weight: 600;
    }

    /* Main Content Area */
    .main-content {
        padding: 2rem;
        max-width: 1600px;
        margin: 0 auto;
    }

    /* Cards */
    .card {
        border: none;
        border-radius: 12px;
        box-shadow: var(--shadow-md);
        background: var(--bg-white);
        margin-bottom: 1.5rem;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .card-title {
        color: var(--text-dark);
        font-weight: 600;
        font-size: 1.25rem;
        margin-bottom: 1.25rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid var(--bg-light);
    }

    /* Video Display */
    #view {
        overflow: hidden;
        box-shadow: var(--shadow-lg);
        background: black;
    }

    #viewgroup {
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
    }

    #video media-stream-player {
        width: 100% !important;
        height: 100% !important;
        object-fit: fill !important;
    }

    /* Custom AOI Selection Overlay */
    #aoi-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1000;
        display: none;
        pointer-events: all;
    }

    #aoi-overlay.active {
        display: block;
    }

    .aoi-box {
        position: absolute;
        border: 2px solid #00ff00;
        background: rgba(0, 255, 0, 0.1);
        cursor: move;
    }

    .aoi-handle {
        position: absolute;
        width: 10px;
        height: 10px;
        background: #00ff00;
        border: 1px solid #fff;
    }

    .aoi-handle.nw { top: -5px; left: -5px; cursor: nw-resize; }
    .aoi-handle.ne { top: -5px; right: -5px; cursor: ne-resize; }
    .aoi-handle.sw { bottom: -5px; left: -5px; cursor: sw-resize; }
    .aoi-handle.se { bottom: -5px; right: -5px; cursor: se-resize; }

    /* Buttons */
    .btn {
        border-radius: 8px;
        padding: 0.65rem 1.25rem;
        font-weight: 500;
        transition: all 0.2s ease;
        border: none;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        color: white;
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-color) 100%);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .btn-secondary {
        background-color: var(--text-muted);
        color: white;
    }

    .btn-secondary:hover {
        background-color: var(--text-dark);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    /* Form Controls */
    .form-control, .form-select {
        border-radius: 8px;
        border: 1px solid var(--border-color);
        padding: 0.65rem 1rem;
        transition: all 0.2s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .form-label {
        color: var(--text-dark);
        font-weight: 500;
        margin-bottom: 0.5rem;
    }

    /* Table */
    .table {
        margin-bottom: 0;
    }

    .table thead th {
        background-color: var(--bg-light);
        color: var(--text-dark);
        font-weight: 600;
        border-bottom: 2px solid var(--border-color);
        padding: 1rem;
    }

    .table tbody td {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
    }

    .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(248, 250, 252, 0.5);
    }

    /* Info Display */
    .info-item {
        padding: 0.5rem 0;
        color: var(--text-muted);
        font-size: 0.95rem;
    }

    .info-item strong {
        color: var(--text-dark);
    }

    /* Loading Modal */
    #modal {
        backdrop-filter: blur(4px);
    }

    #modal > div {
        background: white;
        border-radius: 12px;
        box-shadow: var(--shadow-lg);
        padding: 2rem;
        text-align: center;
    }

    #modal h2 {
        color: var(--text-dark);
        font-weight: 600;
        margin-bottom: 1rem;
    }

    #modal p {
        color: var(--text-muted);
        margin-bottom: 0;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .main-content {
            padding: 1rem;
        }

        .navbar-brand {
            font-size: 1.25rem;
        }

        .nav-pills {
            flex-wrap: wrap;
        }
    }
</style>

</head>

<body>
    <!-- Top Navigation -->
    <nav class="navbar navbar-expand-lg top-navbar">
        <div class="container-fluid">
            <span class="navbar-brand acapName">Custom Model</span>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"
                    style="background-color: rgba(255,255,255,0.2); border: none;">
                <span class="navbar-toggler-icon" style="filter: invert(1);"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto nav-pills">
                    <li class="nav-item">
                        <a class="nav-link active" href="index.html">Detections</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="mqtt.html">MQTT</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="advanced.html">Events/Labels</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="cropping.html">Detection Export</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="about.html">About</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Loading Modal -->
        <div id='modal' style='display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.2); z-index:1000;'>
            <div style='position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:2rem; border-radius:12px; box-shadow:var(--shadow-lg); text-align:center;'>
                <h2>Model Offline</h2>
                <p>The model is currently loading. Please wait.</p>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="row g-4">
            <!-- Left Column: Video and Settings -->
            <div class="col-lg-8">
                <!-- Video Display Card -->
                <div class="card">
                    <div class="card-body">
                        <div id="view" style="width:1000px; height:1000px; max-width:100%; margin:0 auto;">
                            <div style="width:100%; height:100%; position:relative; background-color: black;">
                                <div id="video" style="width:100%; height:100%; position:absolute; top:0px; left:0px;"></div>
                                <canvas id="overlayCanvas" width="1000" height="1000" style="width:100%; height:100%; position:absolute; top:0px; left:0px; pointer-events:none;"></canvas>
                                <canvas id="canvas" width="1000" height="1000" style="width:100%; height:100%; position:absolute; top:0px; left:0px;"></canvas>
                                <!-- AOI Selection Overlay -->
                                <div id="aoi-overlay">
                                    <div class="aoi-box">
                                        <div class="aoi-handle nw"></div>
                                        <div class="aoi-handle ne"></div>
                                        <div class="aoi-handle sw"></div>
                                        <div class="aoi-handle se"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detection Settings Card -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Detection Settings</h5>

                        <div class="mb-3 d-flex align-items-center">
                            <label for="settings_confidence" class="form-label fw-bold mb-0" style="min-width: 180px;">Confidence Threshold</label>
                            <select id="settings_confidence" class="setting form-select" style="width: 120px;">
                                <option value="20">20%</option>
                                <option value="30">30%</option>
                                <option value="40">40%</option>
                                <option value="50">50%</option>
                                <option value="60">60%</option>
                                <option value="70">70%</option>
                                <option value="75">75%</option>
                                <option value="80">80%</option>
                                <option value="85">85%</option>
                                <option value="90">90%</option>
                                <option value="95">95%</option>
                            </select>
                        </div>

                        <div class="mb-3 d-flex align-items-center">
                            <label for="settings_scaleMode" class="form-label fw-bold mb-0" style="min-width: 180px;">Scale Mode</label>
                            <select id="settings_scaleMode" class="setting form-select" style="flex: 1;">
                                <option value="balanced">Balanced - Reduced area, good quality</option>
                                <option value="crop">Center-Crop - Smallest area, best quality</option>
                                <option value="letterbox">Letterbox - Full area, less quality</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Video Information</label>
                            <div class="info-item">Capture Resolution: <strong><span id="captureResolution">-</span></strong></div>
                            <div class="info-item">Model Input: <strong><span id="modelResolution">-</span></strong></div>
                        </div>

                        <div class="d-flex gap-2">
                            <button id="aoi_button" class="btn btn-secondary flex-fill">Set Area Of Interest</button>
                            <button id="size_button" class="btn btn-secondary flex-fill">Set Minimum Size</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Active Events -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Active Event States</h5>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Event</th>
                                    </tr>
                                </thead>
                                <tbody id="events-table">
                                    <!-- Data will be appended here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

	<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="errorModalLabel">Error</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					The application is not running.
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>				

    <div class="toast-container position-fixed top-0 end-0 p-3">
    </div>

<script>
var App = 0;
var imageWidth = 800;
var imageHeight = 450;
var videoWidth = 640;
var videoHeight = 360;
var viewWidth = 1000;
var viewHeight = 562;
var inferenceTimer = 0;
var selectionMode = "";

// Custom AOI Selection State
var aoiState = {
	active: false,
	dragging: false,
	resizing: false,
	resizeHandle: null,
	startX: 0,
	startY: 0,
	x1: 0,
	y1: 0,
	x2: 0,
	y2: 0
};
var setupComplete = false;
		
$(document).ready(function() {
	$.ajax({
		type: "POST",
		url: '/axis-cgi/basicdeviceinfo.cgi',
		dataType: 'json',
		data: '{"apiVersion": "1.0","context": "DetectX","method": "getAllProperties"}',
		cache: false,
		success: function( response ) {
			// if( response.data.propertyList.Soc !== "Axis Artpec-8" ) {
			//	$(".modal-body").html('<b>This camera is not supported.<br/>The camera needs to be based on ARTPEC-8</b>');
			//	$('#errorModal').modal('show');
			//	return;
			// }
			initializePage();
		},
		error: function(response) {
			$('#errorModal').modal('show');
		}
	});
});

function initializePage() {	
	$.ajax({type: "GET",url: 'app',dataType: 'json',cache: false,
		success: function(data) {
			App = data;
			// Update UI elements
			document.title = App.manifest.acapPackageConf.setup.friendlyName;
			$(".acapName").html(App.manifest.acapPackageConf.setup.friendlyName);
			$("#model_status").text("Status: " + App.status.model.status);
			$("#settings_confidence").val(App.settings.confidence);
			$("#settings_scaleMode").val(App.settings.scaleMode || "balanced");

			// Store initial scale mode for revert functionality
			window.previousScaleMode = App.settings.scaleMode || "balanced";

			// Update resolution displays
			if (App.model) {
				$("#captureResolution").text(App.model.videoWidth + " x " + App.model.videoHeight);
				$("#modelResolution").text(App.model.modelWidth + " x " + App.model.modelHeight);
			}

			SetupView(App.model.modelWidth, App.model.modelHeight);


			// Initialize custom AOI overlay
			initializeAOIOverlay();
		},
		error: function(response) {
			$(".modal-body").html('<b>The application is not responding<b/>');
			$('#errorModal').modal('show');
		}
	});

	$("#reset_detections").click(function() {
		var canvas = document.getElementById('canvas');
		var ctx = canvas.getContext("2d");
		ctx.beginPath();
		ctx.clearRect(0, 0, canvas.width, canvas.height);
		ctx.stroke();
		appendDataToTable([]);
		$.ajax({type: "GET",url: 'detections?reset=yes',dataType: 'json',cache: false});
	});

	// Set AOI button click handler
	$("#aoi_button").click(function() {
		if (aoiState.active) {
			// Hide AOI selection
			toggleAOISelection(false);
			$(this).removeClass('btn-primary').addClass('btn-secondary');
		} else {
			// Show AOI selection
			toggleAOISelection(true);
			$(this).removeClass('btn-secondary').addClass('btn-primary');
		}
	});


	$("#settings_confidence").change(function() {
		var confidenceValue = parseInt($(this).val());
		App.settings.confidence = confidenceValue;
		$.ajax({type: "POST",url: "settings",contentType: 'application/json',
			data: JSON.stringify({ confidence: confidenceValue }),
			success: function(response) {
				currentSettings = newSettings;
			},
			error: function(xhr, status, error) {
				alert('Failed to save settings: ' + error);
			}
		});
	});

	$("#settings_scaleMode").change(function() {
		var scaleModeValue = $(this).val();

		// Show confirmation dialog
		if (confirm("This will restart the ACAP. Proceed?")) {
			// User clicked OK - save and restart
			App.settings.scaleMode = scaleModeValue;
			$.ajax({type: "POST",url: "settings",contentType: 'application/json',
				data: JSON.stringify({ scaleMode: scaleModeValue }),
				success: function(response) {
					// Send VAPIX request to restart the ACAP
					$.ajax({
						type: "GET",
						url: "/axis-cgi/applications/control.cgi?action=restart&package=detectx",
						success: function() {
							showToast('ACAP is restarting. Please wait...', 'info');
							window.previousScaleMode = scaleModeValue;
						},
						error: function(xhr, status, error) {
							showToast('Failed to restart ACAP: ' + error, 'danger');
						}
					});
				},
				error: function(xhr, status, error) {
					showToast('Failed to save scale mode: ' + error, 'danger');
					// Revert selection
					$("#settings_scaleMode").val(window.previousScaleMode);
				}
			});
		} else {
			// User clicked Cancel - revert to previous value
			$("#settings_scaleMode").val(window.previousScaleMode);
		}
	});

	setInterval( function(){
		$.ajax({type: "GET",url: 'status',dataType: 'json',cache: false,
			success: function( status ) {
				if( !status.model || !status.model.state ) {
					// Model is not ready - show loading modal
					$('#modal').show();
					return;
				}

				// Model is ready - hide loading modal
				$('#modal').hide();

				if ($('.modal:visible').length && $('body').hasClass('modal-open')) {
					$('#errorModal').modal('hide');
				};
				
				$("#model_status").text("Status: " + status.model.status);

				$('#events-table').empty();
				if( !status.hasOwnProperty("labels") )
					return;

				if( !status.labels.hasOwnProperty("detections") )
					return;
				
				var canvas = document.getElementById('canvas');
				var ctx = canvas.getContext("2d");

				ctx.beginPath();
				ctx.clearRect(0, 0, canvas.width, canvas.height);
				ctx.stroke();
				ctx.lineWidth = 3;
				ctx.strokeStyle = '#FFFF00';
				ctx.font = '24px Arial';  // Set font style and size
				ctx.fillStyle = '#FFFF00'; // Same color as the box
				ctx.beginPath();
				for( var i = 0; i < status.labels.detections.length; i++ ) {
				    var detection = status.labels.detections[i];

					// Transform coordinates from capture space to display space (16:9)
					var transformed = transformCoordinates(detection.x, detection.y, detection.w, detection.h);

					ctx.rect(transformed.x, transformed.y, transformed.w, transformed.h);
					var text = detection.label + ': ' + detection.c;
					ctx.fillText(text, transformed.x, transformed.y - 10); // -10 to position
				}
				ctx.stroke();	

				var events = status.events;
				for( var label in events ) {
					if( events[label] ) {
						var row = '<tr><td>' + label + '</td></tr>';
						$('#events-table').append(row);
					}
				};
			},
			error: function() {
				// ACAP is not responding - show loading modal
				$('#modal').show();
			}
		});
	},300);
};			
	  

function transformCoordinates(x, y, w, h) {
	// Coordinates come from backend as pixels relative to model input (e.g., 640x640)
	var scaleMode = App.settings.scaleMode || "balanced";

	if (scaleMode === "letterbox") {
		// Letterbox mode: scale from model to displayed video size
		// Model is 640x640, displayed video is e.g., 640x360 (scaled down 16:9)
		var videoAspect = videoWidth / videoHeight;
		var displayVideoWidth = App.model.modelWidth;  // Same as view width
		var displayVideoHeight = App.model.modelWidth / videoAspect;

		var scaleX = displayVideoWidth / App.model.modelWidth;
		var scaleY = displayVideoHeight / App.model.modelHeight;

		return {
			x: x * scaleX,
			y: y * scaleY,
			w: w * scaleX,
			h: h * scaleY
		};
	} else {
		// Balanced and crop modes: scale from model space to video space
		// For 640x640 model â†’ 856x640 video: scaleX=1.3375, scaleY=1.0
		var scaleX = videoWidth / App.model.modelWidth;
		var scaleY = videoHeight / App.model.modelHeight;

		return {
			x: x * scaleX,
			y: y * scaleY,
			w: w * scaleX,
			h: h * scaleY
		};
	}
}

function SetupView(modelWidth, modelHeight) {
	// Store model dimensions for coordinate transformation
	App.model.modelWidth = modelWidth;
	App.model.modelHeight = modelHeight;

	// Use video dimensions from model config for view size
	videoWidth = App.model.videoWidth;
	videoHeight = App.model.videoHeight;
	imageWidth = App.model.videoWidth;
	imageHeight = App.model.videoHeight;

	// For letterbox mode, use model dimensions for 1:1 square view
	var scaleMode = App.settings.scaleMode || "balanced";

	if (scaleMode === "letterbox") {
		// View is 1:1 square using model dimensions (e.g., 640x640)
		viewWidth = modelWidth;
		viewHeight = modelWidth;

		// Calculate video's displayed size when letterboxed in square view
		// Video aspect ratio (e.g., 1136:640 = 1.775:1 for 16:9)
		var videoAspect = videoWidth / videoHeight;
		var displayVideoWidth = viewWidth;
		var displayVideoHeight = viewWidth / videoAspect;

		// Calculate letterbox offset (black bars on top/bottom)
		var letterboxOffsetY = (viewHeight - displayVideoHeight) / 2;

		// Canvas matches the displayed video size
		$("#overlayCanvas").attr("width", displayVideoWidth).attr("height", displayVideoHeight);
		$("#canvas").attr("width", displayVideoWidth).attr("height", displayVideoHeight);

		// Set CSS dimensions to match canvas buffer size (not stretched)
		$("#overlayCanvas").css({
			"width": displayVideoWidth + "px",
			"height": displayVideoHeight + "px",
			"top": letterboxOffsetY + "px"
		});
		$("#canvas").css({
			"width": displayVideoWidth + "px",
			"height": displayVideoHeight + "px",
			"top": letterboxOffsetY + "px"
		});
	} else {
		// Balanced and crop modes: view matches video dimensions exactly
		viewWidth = videoWidth;
		viewHeight = videoHeight;

		// Update canvas dimensions to match video
		$("#overlayCanvas").attr("width", videoWidth).attr("height", videoHeight);
		$("#canvas").attr("width", videoWidth).attr("height", videoHeight);

		// Set CSS dimensions in pixels
		$("#overlayCanvas").css({
			"width": videoWidth + "px",
			"height": videoHeight + "px",
			"top": "0px"
		});
		$("#canvas").css({
			"width": videoWidth + "px",
			"height": videoHeight + "px",
			"top": "0px"
		});
	}

	$("#view").css("width", viewWidth + "px");
	$("#view").css("height", viewHeight + "px");

	var secureConnection = "";
	if (location.protocol === 'https:')
		secureConnection = "secure=true"
	var player = '<media-stream-player hostname="' + window.location.hostname + '" ' + secureConnection + '  format="RTP_H264" compression="40" audio="0" resolution="' + videoWidth + 'x' + videoHeight + '" variant="basic" autoplay></media-stream-player>';
	$("#video").append(player);

	setupComplete = true;
}


function appendDataToTable(dataArray) {
	var $tableBody = $("#detection-table");
	$tableBody.empty(); // Clear existing data
	dataArray.forEach(function(item) {
		var row = '<tr><td>' + item.label + ' </td><td>' + item.c + '</td></tr>';
		$tableBody.append(row);
	});
}

function showToast(message, type = 'danger') {
    const toastContainer = document.querySelector('.toast-container');
    
    // Determine text color class based on type
    const textColorClass = type === 'warning' ? 'text-dark' : 'text-white';
    
    // Create the toast HTML structure
    var toastHtml = '';
    toastHtml += '<div class="toast align-items-center ' + textColorClass + ' bg-' + type + ' border-0" role="alert" aria-live="assertive" aria-atomic="true">';
    toastHtml += '   <div class="d-flex">';
    toastHtml += '     <div class="toast-body">' + message + '</div>';
    toastHtml += '     <button type="button" class="btn-close' + (type === 'warning' ? '' : ' btn-close-white') + ' me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>';
    toastHtml += '   </div>';
    toastHtml += '</div>';
    
    // Rest of the function remains the same
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    const toastElement = toastContainer.lastElementChild;
    const toast = new bootstrap.Toast(toastElement, {
        autohide: true,
        delay: 4000
    });
    toast.show();
    toastElement.addEventListener('hidden.bs.toast', function() {
        this.remove();
    });
}

// Custom AOI Selection Implementation
function initializeAOIOverlay() {
	var overlay = document.getElementById('aoi-overlay');
	var box = overlay.querySelector('.aoi-box');
	var handles = overlay.querySelectorAll('.aoi-handle');

	// Set initial AOI position from settings (pixel coordinates)
	aoiState.x1 = App.settings.aoi.x1;
	aoiState.y1 = App.settings.aoi.y1;
	aoiState.x2 = App.settings.aoi.x2;
	aoiState.y2 = App.settings.aoi.y2;

	// Update box position
	updateAOIBox();

	// Mouse down on box (start dragging)
	box.addEventListener('mousedown', function(e) {
		if (e.target.classList.contains('aoi-handle')) return; // Let handles handle themselves
		aoiState.dragging = true;
		aoiState.startX = e.clientX;
		aoiState.startY = e.clientY;
		aoiState.dragStartX1 = aoiState.x1;
		aoiState.dragStartY1 = aoiState.y1;
		aoiState.dragStartX2 = aoiState.x2;
		aoiState.dragStartY2 = aoiState.y2;
		e.preventDefault();
	});

	// Mouse down on handles (start resizing)
	handles.forEach(function(handle) {
		handle.addEventListener('mousedown', function(e) {
			aoiState.resizing = true;
			aoiState.resizeHandle = handle.className.split(' ')[1]; // nw, ne, sw, se
			aoiState.startX = e.clientX;
			aoiState.startY = e.clientY;
			aoiState.dragStartX1 = aoiState.x1;
			aoiState.dragStartY1 = aoiState.y1;
			aoiState.dragStartX2 = aoiState.x2;
			aoiState.dragStartY2 = aoiState.y2;
			e.preventDefault();
			e.stopPropagation();
		});
	});

	// Mouse move (drag or resize)
	document.addEventListener('mousemove', function(e) {
		if (!aoiState.active) return;

		if (aoiState.dragging) {
			var viewRect = document.getElementById('view').getBoundingClientRect();
			// Convert pixel delta to model space
			var deltaX = (e.clientX - aoiState.startX) / viewRect.width * App.model.modelWidth;
			var deltaY = (e.clientY - aoiState.startY) / viewRect.height * App.model.modelHeight;

			var width = aoiState.dragStartX2 - aoiState.dragStartX1;
			var height = aoiState.dragStartY2 - aoiState.dragStartY1;

			aoiState.x1 = Math.max(0, Math.min(App.model.modelWidth - width, aoiState.dragStartX1 + deltaX));
			aoiState.y1 = Math.max(0, Math.min(App.model.modelHeight - height, aoiState.dragStartY1 + deltaY));
			aoiState.x2 = aoiState.x1 + width;
			aoiState.y2 = aoiState.y1 + height;

			updateAOIBox();
		} else if (aoiState.resizing) {
			var viewRect = document.getElementById('view').getBoundingClientRect();
			var deltaX = (e.clientX - aoiState.startX) / viewRect.width * App.model.modelWidth;
			var deltaY = (e.clientY - aoiState.startY) / viewRect.height * App.model.modelHeight;

			var x1 = aoiState.dragStartX1;
			var y1 = aoiState.dragStartY1;
			var x2 = aoiState.dragStartX2;
			var y2 = aoiState.dragStartY2;

			// Update based on which handle
			switch(aoiState.resizeHandle) {
				case 'nw':
					x1 += deltaX;
					y1 += deltaY;
					break;
				case 'ne':
					x2 += deltaX;
					y1 += deltaY;
					break;
				case 'sw':
					x1 += deltaX;
					y2 += deltaY;
					break;
				case 'se':
					x2 += deltaX;
					y2 += deltaY;
					break;
			}

			// Clamp and ensure minimum size (6 pixels)
			x1 = Math.max(0, Math.min(x1, App.model.modelWidth - 6));
			y1 = Math.max(0, Math.min(y1, App.model.modelHeight - 6));
			x2 = Math.max(6, Math.min(x2, App.model.modelWidth));
			y2 = Math.max(6, Math.min(y2, App.model.modelHeight));

			// Ensure x1 < x2 and y1 < y2
			if (x1 < x2 && y1 < y2 && (x2 - x1) >= 6 && (y2 - y1) >= 6) {
				aoiState.x1 = x1;
				aoiState.y1 = y1;
				aoiState.x2 = x2;
				aoiState.y2 = y2;
				updateAOIBox();
			}
		}
	});

	// Mouse up (stop dragging/resizing)
	document.addEventListener('mouseup', function(e) {
		if (aoiState.dragging || aoiState.resizing) {
			// Save AOI to backend
			var aoi = {
				x1: Math.round(aoiState.x1),
				y1: Math.round(aoiState.y1),
				x2: Math.round(aoiState.x2),
				y2: Math.round(aoiState.y2)
			};

			$.ajax({
				type: "POST",
				url: "settings",
				contentType: 'application/json',
				data: JSON.stringify({ aoi: aoi }),
				success: function(response) {
					App.settings.aoi = aoi;
					showToast("Area of Interest updated successfully", "success");
				},
				error: function(response) {
					showToast("Failed to update Area of Interest: " + response.statusText, "danger");
				}
			});

			aoiState.dragging = false;
			aoiState.resizing = false;
		}
	});
}

function updateAOIBox() {
	var box = document.querySelector('.aoi-box');
	if (!box) return;

	// Convert from pixel coordinates to percentage of view
	var scaleX = 100.0 / App.model.modelWidth;
	var scaleY = 100.0 / App.model.modelHeight;

	var left = aoiState.x1 * scaleX;
	var top = aoiState.y1 * scaleY;
	var width = (aoiState.x2 - aoiState.x1) * scaleX;
	var height = (aoiState.y2 - aoiState.y1) * scaleY;

	box.style.left = left + '%';
	box.style.top = top + '%';
	box.style.width = width + '%';
	box.style.height = height + '%';
}

function toggleAOISelection(active) {
	var overlay = document.getElementById('aoi-overlay');
	aoiState.active = active;

	if (active) {
		overlay.classList.add('active');
		updateAOIBox();
	} else {
		overlay.classList.remove('active');
	}
}

</script>
</body>


</html>
